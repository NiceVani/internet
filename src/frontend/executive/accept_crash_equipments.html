<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <title>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ä‡∏≥‡∏£‡∏∏‡∏î</title>
    <!-- Bootstrap 5 Bundle CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css"
      integrity="sha512-Evv84Mr4kqVGRNSgIGL/F/aIDqQb7xQ2vcrdIwxfjThSH8CSR7PBEakCr51Ck+w+/U6swU2Im1vVX0SVk9ABhg=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
   
    <style>
        .content-area { margin-left: 290px; }
        @media (max-width: 576px) { .content-area { margin-left: 0; } }

          body {
            font-family: Arial, sans-serif;
          }
    
          .content-area {
            /* ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á main contenet*/
            margin-left: 290px; /* ‡πÄ‡∏ß‡πâ‡∏ô‡∏î‡πâ‡∏≤‡∏ô‡∏ã‡πâ‡∏≤‡∏¢‡∏Å‡∏±‡∏ô‡∏ó‡∏±‡∏ö‡∏Å‡∏±‡∏ö Sidebar */
          }
          /* Responsive: ‡∏à‡∏≠‡πÄ‡∏•‡πá‡∏Å */
          @media (max-width: 576px) {
            .sidebar {
              position: relative;
              width: 100%;
              max-width: 100%;
              box-shadow: none;
            }
            .content-area {
              margin-left: 0;
            }
          }
          /* ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Filter Area */
          .filter-row {
            margin-top: 1rem;
            margin-bottom: 1rem;
          }
          .filter-row label {
            margin-right: 0.5rem;
            font-weight: bold;
          }
          .filter-row select,
          .filter-row input[type="date"] {
            width: auto;
            display: inline-block;
            margin-right: 1rem;
          }
          .card-header {
            font-size: 1.25rem;
          }
        </style>
    </style>
</head>
<body>
  <body>
    <!-- ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤ -->
    <div id="sidebar-container"></div>
    <div class="container">
      <div class="content-area">
        <div class="container-fluid py-3">
          <!-- Nav Tabs -->
          <ul class="nav nav-tabs" id="myTab" role="tablist">
            <!-- ‡πÅ‡∏ó‡πá‡∏ö ‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ä‡∏≥‡∏£‡∏∏‡∏î -->
            <li class="nav-item" role="presentation">
              <button
              class="nav-link"
                id="broken-tab"
                data-bs-toggle="tab"
                data-bs-target="#broken"
                type="button"
                role="tab"
                aria-controls="broken"
                aria-selected="false"
              >
                ‡∏£‡∏≠‡∏ã‡πà‡∏≠‡∏°
              </button>
            </li>
            
            <li class="nav-item" role="presentation">
              <button
                class="nav-link active"
                id="accepted-tab"
                data-bs-toggle="tab"
                data-bs-target="#accepted"
                type="button"
                role="tab"
                aria-controls="accepted"
                aria-selected="true"
              >
                ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£
              </button>
            </li>
            <li class="nav-item" role="presentation">
              <button
              class="nav-link"
                id="success-tab"
                data-bs-toggle="tab"
                data-bs-target="#success"
                type="button"
                role="tab"
                aria-controls="success"
                aria-selected="false"
              >
               ‡∏ã‡πà‡∏≠‡∏°‡πÄ‡∏™‡∏£‡πá‡∏à
              </button>
            </li>
          </ul>

          <!-- ‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡∏≠‡∏á Filter -->
          <div class="row filter-row">
            <div class="col-12">
              <label for="typeFilter">‡∏ä‡∏ô‡∏¥‡∏î‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå:</label>
              <select id="typeFilter" class="form-select d-inline-block">
                <option value="all">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                <option value="‡∏à‡∏≠‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå">‡∏à‡∏≠‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå</option>
                <option value="‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå">‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå</option>
                <option value="‡πÄ‡∏Å‡πâ‡∏≤‡∏≠‡∏µ‡πâ">‡πÄ‡∏Å‡πâ‡∏≤‡∏≠‡∏µ‡πâ</option>
                <option value="‡πÇ‡∏ï‡πä‡∏∞">‡πÇ‡∏ï‡πä‡∏∞</option>
                <option value="‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏õ‡∏£‡∏±‡∏ö‡∏≠‡∏≤‡∏Å‡∏≤‡∏®">‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏õ‡∏£‡∏±‡∏ö‡∏≠‡∏≤‡∏Å‡∏≤‡∏®</option>
                <option value="‡∏õ‡∏•‡∏±‡πä‡∏Å‡πÑ‡∏ü">‡∏õ‡∏•‡∏±‡πä‡∏Å‡πÑ‡∏ü</option>
              </select>

              <label for="roomFilter">‡∏´‡πâ‡∏≠‡∏á:</label>
              <select id="roomFilter" class="form-select d-inline-block">
                <option value="all">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                <option value="414">SC2-414</option>
                <option value="307">SC2-307</option>
              </select>

              <!-- ‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô -->
              <label for="reportDate">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</label>
              <input
                type="date"
                id="reportDate"
                class="form-control d-inline-block"
              />

              <!-- ‡∏à‡∏±‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏° ‚Äú‡∏°‡∏≤‡∏Å‡πà‡∏≠‡∏ô‚Äù / ‚Äú‡∏´‡∏•‡∏±‡∏á‡∏™‡∏∏‡∏î‚Äù -->
              <label for="sortOrder">‡∏à‡∏±‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°:</label>
              <select id="sortOrder" class="form-select d-inline-block">
                <option value="asc">‡πÄ‡∏Å‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î</option>
                <option value="desc">‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î</option>
              </select>
              <!-- ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏î‡∏Å‡∏£‡∏≠‡∏á -->
            </div>
          </div>
          <!-- /Filter -->
          
          <!-- Tab Contents -->
          <div class="tab-content">
            <div class="tab-pane fade" id="broken"></div>
            <div class="tab-pane fade show active" id="accepted">
                <div id="equipment-list"></div> <!-- ‚úÖ Container -->
            </div>
        </div>
    </div>
</div>

<script>
  async function fetchData() {
    try {
        console.log("üî• Fetching data...");

        const [brokenResponse, studentResponse, teachersResponse, equipmentsResponse] = await Promise.all([
            fetch('http://localhost:3000/equipment_brokened'),
            fetch('http://localhost:3000/student'),
            fetch('http://localhost:3000/teacher'),
            fetch('http://localhost:3000/equipment'),
        ]);

        const brokenData = await brokenResponse.json();
        const studentData = await studentResponse.json();
        const teachersData = await teachersResponse.json();
        const equipmentsData = await equipmentsResponse.json();

        console.log("üî• API Data Loaded:", brokenData);

        let statusFilter = ['‡∏£‡∏±‡∏ö‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß','‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏±‡∏î‡∏ã‡∏∑‡πâ‡∏≠','‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ã‡πà‡∏≠‡∏°'];

        const mergedData = brokenData
            .filter(row => statusFilter.includes(row.repair_status))
            .map(item => {
                const student = studentData.find(s => s.student_id === item.student_id) || {};
                const teacher = teachersData.find(t => t.teacher_id === item.teacher_id) || {};
                const equipment = equipmentsData.find(e => e.equipment_id === item.equipment_id) || {};

                return {
                    ...item,
                    repairDate: item.repair_date ? new Date(item.repair_date).toLocaleDateString('th-TH') : '-',
                    email: student.email || teacher.email || '-',
                    person_name: student.full_name || teacher.full_name || '-',
                    equipmentName: equipment.equipment_name || '-',
                    equipmentType: equipment.equipment_type || '-',
                    damageDetails: item.damage_details || '-',
                    
                    imagePath: item.image_path ? `http://localhost:3000/image/${item.image_path}` : null
                };
            });

            console.log("üî• Merged Data:", mergedData);

            // ‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ï‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
            filterData("all", "all", "", mergedData);
    
            // ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Ñ‡πà‡∏≤‡πÉ‡∏ô Dropdown ‡πÅ‡∏•‡∏∞‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô
            document.getElementById("typeFilter").addEventListener("change", function () {
                const selectedType = this.value;
                const selectedRoom = document.getElementById("roomFilter").value;
                const selectedDate = document.getElementById("reportDate").value;
                filterData(selectedType, selectedRoom, selectedDate, mergedData);
            });
    
            document.getElementById("roomFilter").addEventListener("change", function () {
                const selectedType = document.getElementById("typeFilter").value;
                const selectedRoom = this.value;
                const selectedDate = document.getElementById("reportDate").value;
                filterData(selectedType, selectedRoom, selectedDate, mergedData);
            });
    
            document.getElementById("reportDate").addEventListener("change", function () {
                const selectedType = document.getElementById("typeFilter").value;
                const selectedRoom = document.getElementById("roomFilter").value;
                const selectedDate = this.value;
                filterData(selectedType, selectedRoom, selectedDate, mergedData);
            });
    
        } catch (error) {
            console.error("‚ùå Fetch Error:", error);
        }
      }
    
      function filterData(selectedType, selectedRoom, selectedDate, data) {
        const equipmentContainer = document.getElementById("equipment-list");
        equipmentContainer.innerHTML = "";
    
        let filteredData = data;
        
        // ‚úÖ ‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏ä‡∏ô‡∏¥‡∏î‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå
        if (selectedType !== "all") {
            filteredData = filteredData.filter(item => item.equipmentName === selectedType);
        }
    
        // ‚úÖ ‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏´‡πâ‡∏≠‡∏á
        if (selectedRoom !== "all") {
            filteredData = filteredData.filter(item => item.room_id === selectedRoom);
        }
    
        // ‚úÖ ‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà (‡∏ñ‡πâ‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å)
        if (selectedDate) {
            filteredData = filteredData.filter(item => item.repairDate === selectedDate);
        }
    
        if (filteredData.length === 0) {
            equipmentContainer.innerHTML = "<p class='text-muted'>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç</p>";
            return;
        }
      filteredData.forEach((item) => {
          const equipmentCard = `
              <div class="card my-3">
                  <div class="card-header h5">${item.equipmentName}</div>
                  <div class="card-body d-flex align-items-start">
                      ${item.imagePath ? `<img src="${item.imagePath}" alt="‡∏†‡∏≤‡∏û‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ä‡∏≥‡∏£‡∏∏‡∏î" class="img-fluid me-3" style="max-width: 200px; max-height: 200px;">` : ''}
                      <div>
                          <p><strong>${item.damageDetails}</strong></p>
                          <p><strong>‡∏´‡πâ‡∏≠‡∏á:</strong> ${item.room_id}</p>
                          <p><strong>‡∏ú‡∏π‡πâ‡πÅ‡∏à‡πâ‡∏á:</strong> ${item.person_name}</p>
                          <p><strong>‡∏≠‡∏µ‡πÄ‡∏°‡∏•:</strong> ${item.email}</p>
                          <p><strong>‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠:</strong> ${item.repairDate}</p>
                          <p><strong>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</strong> ${item.repair_status}</p>
                      </div>
                  </div>
              </div>
          `;
          equipmentContainer.innerHTML += equipmentCard;
      });
  }

  document.addEventListener("DOMContentLoaded", fetchData);

// ‡πÇ‡∏´‡∏•‡∏î Sidebar
fetch("sidebar.html")
        .then((resp) => resp.text())
        .then((html) => {
          document.getElementById("sidebar-container").innerHTML = html;
        })
        .then(() => {
          // Highlight ‡∏õ‡∏∏‡πà‡∏° "‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á"
          const btnStats = document.getElementById("btnBroken");
          btnStats.classList.add("btn-sidebar-active");
        })
        .catch((err) => console.error("Failed to load sidebar:", err));

// ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Event Listener ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡∏ï‡∏≤‡∏°‡πÅ‡∏ó‡πá‡∏ö
document.addEventListener("DOMContentLoaded", function () {
    const brokenTab = document.querySelector("#broken-tab"); // ‡πÅ‡∏ó‡πá‡∏ö "‡∏£‡∏≠‡∏ã‡πà‡∏≠‡∏°"
    const acceptedTab = document.querySelector("#accepted-tab"); // ‡πÅ‡∏ó‡πá‡∏ö "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£"
    const successTab = document.querySelector("#success-tab");
    

    if (brokenTab) {
        brokenTab.addEventListener("click", function () {
            window.location.href = "crash_equipments_requests.html"; // ‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ crash_equipments_requests.html
        });
    } else {
        console.error("‚ùå broken-tab not found!");
    }

    if (successTab) {
        successTab.addEventListener("click", function () {
            window.location.href = "successful_equipments.html"; // ‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ accept_crash_equipments.html
        });
    } else {
        console.error("‚ùå accepted-tab not found!");
    }
});

</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

</body>
</html>